{# Form that is called when creating a new booking #}
{% load static %}
{% load tags %}

{% block content %}
    <div id="content-container" class="row">
        <div class="col-lg-6" id="booking-cards-con">
            <h5 id="booked-title">Booked</h5>
            <div id="booking-cards">
            </div>
        </div>
        {% if user.is_authenticated %}
            {% user_in_hs user as user_in_hs %}
            {% if user_in_hs or request.user.is_superuser %}
                {% load widget_tweaks %}
                <div class="col-lg-5" id="booking-fields">
                    <div class="col form-group {% if field.errors %} has-error{% endif %}">
                        {{form.person.as_hidden}}
                        {{form.location.as_hidden}}
                        {{form.day.as_hidden}}
                        {{form.queueNo.as_hidden}}
                        <div>
                            <h5>Title</h5>
                            {{form.title}}
                        </div>
                        <div class="form-margin">
                            <h5>Group</h5>
                            {{form.group}}
                        </div>
                        <div class="form-margin">
                            <h5>Description</h5>
                            {{form.description}}
                        </div>
                        <div class="form-margin">
                            <h5>Starttime</h5>
                            <div class="input-group clockpicker" data-placement="top" data-align="bottom" data-autoclose="true" id="startTime">
                                <input type="text" class="form-control" value="Choose start time" id="startInput" onclick="resetClock()" required>
                                <span class="input-group-addon" onclick="resetClock()">
                                <span class="glyphicon glyphicon-time"></span>
                                </span>
                            </div>
                        </div>
                        <div class="form-margin">
                            <h5>Endtime</h5>
                            <div class="input-group clockpicker" data-placement="top" data-align="bottom" data-autoclose="true" id="endTime" >
                                <input type="text" class="form-control" value="Choose end time" id="endInput" onclick="editClock()" required>
                                <span class="input-group-addon" i id="endTimeSpan">
                                <span class="glyphicon glyphicon-time" ></span>
                                </span>
                            </div>
                        </div>
                        {% if request.user.is_superuser %}
                            <div class="form-margin">
                                <h5>Recurring</h5>
                                {{form.repeat}}
                            </div>
                        {% endif %}
                        {% if user.is_authenticated and not request.user.is_superuser %}
                            {% user_in_hs user as user_in_hs %}
                            {% if user_in_hs %}
                                <div class="form-margin">
                                    <h5>Request Recurring</h5>
                                    {{form.repeat}}
                                </div>
                            {% endif %}
                        {% endif %}
                        <p id="errorMessage"></p>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% load widget_tweaks %}
    </div>
{% endblock content %}

{% block script %}
    <script>
        $.ajax({
            method: "GET",
            url: '/booking/api',
            beforeSend: function(){
                var promised = promiseTest();
                promised.done(function() {
                    promised.then( function() {
                        globalList = [];
                        globalList.push(promised.responseJSON);
                    })
                })
            },
            success: function(data) {
                // Making list of bookings
                var bookings = []
                $.each(data, function(i, item){
                    booking_data = data;
                    var date = data[i].start;
                    var date_format = date.slice(0, 10);
                    var start = date.slice(11, 16);
                    var newDate = start.replace(":", "");
                    var locId = data[i].location__name;
                    var loc = document.getElementById(locId);
                    var queueNo = data[i].queueNo;
                    var group = data[i].group;
                    var personId = data[i].person__id;
                    var dayName = new Date(tempDay.id.substring(0,4), +tempDay.id.substring(5,7)-1,
                        tempDay.id.substring(8,10)).toString().slice(0,3);
                    dayName.value = tempDay.children[1].innerHTML.trim();
                    var mail = data[i].person__email;
                    var fName = data[i].person__first_name;
                    var lName = data[i].person__last_name;
                    if(tempDay.id === date_format && data[i].location__name === loc.value && loc.checked === true){
                        var booking = [];
                        booking.push(newDate, start, data[i].end, data[i].title,
                            fName, queueNo, group, personId, lName, mail);
                        bookings.push(booking);
                        bookings.sort(function(a, b){return a[0] - b[0]});
                    }
                });
                // Filling out modal with bookings cards
                if(bookings.length != 0){
                    for (var I = 0; I < bookings.length; I++) {
                        var queueNo = bookings[I][5];
                        if (queueNo == 0) {
                            var div = document.createElement("div");
                            div.className = "col-sm-10";
                            var div2 = document.createElement("div");
                            div2.className = "card";
                            var div3 = document.createElement("div");
                            div3.className = "card-body" + " " + bookings[I][7];
                            var date = document.createElement("h5");
                            date.className = "card-title";

                            var start_time = bookings[I][1];
                            var end_time = bookings[I][2].slice(11, 16);
                            date.innerHTML = start_time + "-" + end_time;

                            var title = document.createElement("p");
                            title.className = "card-text";
                            title.innerHTML = bookings[I][3];

                            var group = document.createElement("h8");
                            group.className = "card-subtitle";
                            group.innerHTML = bookings[I][6];

                            var name = document.createElement("h6");
                            name.className = "card-subtitle text-muted mb-2";
                            var f_name = bookings[I][4];
                            var l_name = bookings[I][8];
                            name.innerHTML = f_name + " " + l_name;

                            var mail = document.createElement("h6");
                            mail.className = "card-subtitle";
                            mail.innerHTML = bookings[I][9];

                            div3.appendChild(date);
                            div3.appendChild(title);
                            div3.appendChild(group);
                            div3.appendChild(name);
                            div3.appendChild(mail);
                            div2.appendChild(div3);
                            div.appendChild(div2);
                            document.getElementById("booking-cards").appendChild(div);
                        }
                        // Making the users cards marked and clickable
                        var userId = {{ user.id }};
                        if(userId == bookings[I][7] && bookings[I][5] == 0){
                            div3.style.borderBottom = "2px solid darkslategrey";
                            div3.style.cursor = "pointer";
                            div3.title = "Click to see your booking";
                            var myCards = document.getElementsByClassName(bookings[I][7]);
                            for(var i=0; i < myCards.length; i++){
                                myCards[i].onclick = function(){
                                    window.location = "/booking/bookings_list";
                                }
                            }
                        }
                    }
                }else{
                    var empty = document.createElement("h5");
                    empty.innerHTML = "No bookings today!";
                    empty.className = "empty";
                    document.getElementById("booking-cards").appendChild(empty);
                }
            }
        });
    </script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script type="text/javascript" src="{% static 'js/popup.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/form_alert.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/clockpicker.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/form_validator.js' %}"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="{% static 'js/sweetalert.min.js' %}"></script>
{% endblock script %}